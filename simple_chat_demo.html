<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– ê°„ë‹¨í•œ ì•„ë°”íƒ€ ì±„íŒ… ë°ëª¨</title>
    <style>
        :root {
            /* ë¼ì´íŠ¸ ëª¨ë“œ (ê¸°ë³¸) */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: rgba(255, 255, 255, 0.1);
            --text-color: white;
            --header-bg: rgba(255, 255, 255, 0.1);
            --message-bg: rgba(0, 0, 0, 0.1);
            --user-bubble: rgba(76, 175, 80, 0.3);
            --bot-bubble: rgba(255, 255, 255, 0.3);
            --input-bg: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.2);
        }
        
        body.dark-mode {
            /* ë‹¤í¬ ëª¨ë“œ */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: rgba(30, 30, 30, 0.95);
            --text-color: #e0e0e0;
            --header-bg: rgba(40, 40, 40, 0.9);
            --message-bg: rgba(20, 20, 20, 0.5);
            --user-bubble: rgba(76, 175, 80, 0.6);
            --bot-bubble: rgba(60, 60, 60, 0.8);
            --input-bg: rgba(50, 50, 50, 0.8);
            --border-color: rgba(100, 100, 100, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
        }
        
        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 80vh;
            background: var(--container-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .header {
            padding: 20px;
            text-align: center;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1) rotate(20deg);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-toggle:active {
            transform: scale(0.95) rotate(20deg);
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        
        .status {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9em;
        }
        
        .status-item {
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .status-item.connected {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            padding: 20px;
            padding-bottom: 30px;
            gap: 20px;
            overflow-y: auto;
        }
        
        .avatar-section {
            width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .avatar-display {
            width: 200px;
            height: 200px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            font-size: 4em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* ì•„ë°”íƒ€ ì• ë‹ˆë©”ì´ì…˜ */
        .avatar-display.talking {
            animation: talking 0.5s ease-in-out infinite;
        }
        
        .avatar-display.thinking {
            animation: thinking 1.5s ease-in-out infinite;
        }
        
        .avatar-display img {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes talking {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes thinking {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .avatar-display:hover {
            animation: bounce 0.6s ease-in-out;
        }
        
        .emotion-info {
            text-align: center;
            width: 100%;
        }
        
        .emotion-info h3 {
            margin-bottom: 10px;
        }
        
        .avatar-type-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 25px;
        }
        
        .avatar-type-btn {
            flex: 1;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid transparent;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .avatar-type-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .avatar-type-btn.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.3);
        }
        
        .emotion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .emotion-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .emotion-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .emotion-btn.active {
            background: rgba(76, 175, 80, 0.5);
            border: 2px solid rgba(76, 175, 80, 0.8);
        }
        
        .messages-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: var(--message-bg);
            border-radius: 15px;
            margin-bottom: 20px;
            scroll-behavior: smooth;
        }
        
        .messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .message.user .message-bubble {
            background: var(--user-bubble);
            border-bottom-right-radius: 6px;
            animation: slideInRight 0.3s ease-out;
        }
        
        .message.bot .message-bubble {
            background: var(--bot-bubble);
            border-bottom-left-radius: 6px;
            animation: slideInLeft 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .message-time {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-shrink: 0;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            backdrop-filter: blur(5px);
        }
        
        .message-input::placeholder {
            color: rgba(200, 200, 200, 0.7);
        }
        
        .message-input:focus {
            outline: none;
            border-color: rgba(76, 175, 80, 0.8);
        }
        
        .send-btn {
            padding: 12px 20px;
            background: rgba(76, 175, 80, 0.5);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover:not(:disabled) {
            background: rgba(76, 175, 80, 0.7);
            transform: translateY(-2px);
        }
        
        .send-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
        }
        
        .typing {
            opacity: 0.7;
            font-style: italic;
        }
        
        .typing::after {
            content: "...";
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 1; }
            30% { opacity: 0.5; }
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .chat-area {
                flex-direction: column;
                padding: 15px;
                padding-bottom: 20px;
            }
            
            .avatar-section {
                width: 100%;
                margin-bottom: 20px;
            }
            
            .avatar-display {
                width: 150px;
                height: 150px;
            }
            
            .messages-section {
                height: 50vh;
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="í…Œë§ˆ ì „í™˜">
                <span id="theme-icon">ğŸŒ™</span>
            </button>
            <h1>ğŸ¤– ì‹¤ì‹œê°„ ì•„ë°”íƒ€ ìƒë‹´ ì±„íŒ…</h1>
            <div class="status">
                <div class="status-item connected" id="api-status">ğŸ“¡ API ì—°ê²°ë¨</div>
                <div class="status-item" id="emotion-status">ğŸ˜ ì¤‘ë¦½</div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="avatar-section">
                <div class="avatar-display" id="avatar">
                    ğŸ˜
                </div>
                <div class="emotion-info">
                    <h3 id="current-emotion">ì¤‘ë¦½ ìƒë‹´ì‚¬</h3>
                    <p id="emotion-description">í¸ì•ˆí•œ ë§ˆìŒìœ¼ë¡œ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”</p>
                    
                    <!-- ì•„ë°”íƒ€ íƒ€ì… ì„ íƒ -->
                    <div class="avatar-type-selector">
                        <button class="avatar-type-btn active" onclick="changeAvatarType('emoji')">
                            ğŸ˜Š ì´ëª¨ì§€
                        </button>
                        <button class="avatar-type-btn" onclick="changeAvatarType('image')">
                            ğŸ¨ ì´ë¯¸ì§€
                        </button>
                    </div>
                    
                    <div class="emotion-buttons">
                        <button class="emotion-btn active" onclick="changeEmotion('neutral', 'ğŸ˜')">ğŸ˜ ì¤‘ë¦½</button>
                        <button class="emotion-btn" onclick="changeEmotion('joy', 'ğŸ˜Š')">ğŸ˜Š ê¸°ì¨</button>
                        <button class="emotion-btn" onclick="changeEmotion('sad', 'ğŸ˜¢')">ğŸ˜¢ ìŠ¬í””</button>
                        <button class="emotion-btn" onclick="changeEmotion('anxiety', 'ğŸ˜°')">ğŸ˜° ë¶ˆì•ˆ</button>
                        <button class="emotion-btn" onclick="changeEmotion('anger', 'ğŸ˜ ')">ğŸ˜  ë¶„ë…¸</button>
                    </div>
                </div>
            </div>
            
            <div class="messages-section">
                <div class="messages" id="messages">
                    <div class="message bot">
                        <div class="message-bubble">
                            <div>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì‹¤ì‹œê°„ ê°ì • ë¶„ì„ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸŒŸ</div>
                            <div>ë§ˆìŒ í¸í•˜ê²Œ ë¬´ì—‡ì´ë“  ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”. ë‹¹ì‹ ì˜ ê°ì •ì„ ì´í•´í•˜ê³  ê³µê°í•˜ê² ìŠµë‹ˆë‹¤.</div>
                            <div class="message-time">ë°©ê¸ˆ ì „</div>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ)"
                        rows="2"
                    ></textarea>
                    <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEmotion = 'neutral';
        let isTyping = false;
        let avatarType = 'emoji'; // 'emoji' ë˜ëŠ” 'image'
        let isDarkMode = false; // ë‹¤í¬ëª¨ë“œ ìƒíƒœ
        
        // í…Œë§ˆ ì „í™˜ í•¨ìˆ˜
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            const themeIcon = document.getElementById('theme-icon');
            themeIcon.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            
            // í…Œë§ˆ ìƒíƒœ ì €ì¥
            localStorage.setItem('darkMode', isDarkMode);
            console.log(`ğŸ¨ í…Œë§ˆ ì „í™˜: ${isDarkMode ? 'ë‹¤í¬ëª¨ë“œ' : 'ë¼ì´íŠ¸ëª¨ë“œ'}`);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í…Œë§ˆ ì ìš©
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            }
        });
        
        const emotions = {
            neutral: { 
                icon: 'ğŸ˜', 
                name: 'ì¤‘ë¦½ ìƒë‹´ì‚¬', 
                desc: 'í¸ì•ˆí•œ ë§ˆìŒìœ¼ë¡œ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”',
                image: 'avatar/mark_free_ko/neutral.png',
                responses: [
                    "ë„¤, ì˜ ë“¤ì—ˆìŠµë‹ˆë‹¤. ë” ìì„¸íˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?",
                    "ê·¸ë ‡êµ°ìš”. ì–´ë–¤ ê¸°ë¶„ì´ì‹ ì§€ ê¶ê¸ˆí•´ìš”.",
                    "ì´í•´í–ˆìŠµë‹ˆë‹¤. ê³„ì† ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”."
                ]
            },
            joy: { 
                icon: 'ğŸ˜Š', 
                name: 'ê¸°ì¨ ìƒë‹´ì‚¬', 
                desc: 'í•¨ê»˜ ê¸°ì¨ì„ ë‚˜ëˆ„ì–´ìš”!',
                image: 'avatar/mark_free_ko/joy.png',
                responses: [
                    "ì •ë§ ê¸°ì˜ì‹  ê²ƒ ê°™ë„¤ìš”! ğŸ˜Š ì–´ë–¤ ì¢‹ì€ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ìš”?",
                    "ê¸ì •ì ì¸ ì—ë„ˆì§€ê°€ ëŠê»´ì ¸ìš”! âœ¨ ë” ìì„¸íˆ ë“¤ë ¤ì£¼ì„¸ìš”.",
                    "ê¸°ìœ ë§ˆìŒì´ ì „í•´ì§‘ë‹ˆë‹¤! ğŸŒŸ ê³„ì† ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”."
                ]
            },
            sad: { 
                icon: 'ğŸ˜¢', 
                name: 'ê³µê° ìƒë‹´ì‚¬', 
                desc: 'ìŠ¬í”ˆ ë§ˆìŒì„ í•¨ê»˜ ë‚˜ëˆ„ì–´ìš”',
                image: 'avatar/mark_free_ko/sad.png',
                responses: [
                    "í˜ë“œì‹  ë§ˆìŒì´ ëŠê»´ì§‘ë‹ˆë‹¤. ğŸ˜” ì œê°€ ë“¤ì–´ë“œë¦´ê²Œìš”.",
                    "ê´œì°®ìŠµë‹ˆë‹¤. ì²œì²œíˆ ë§ì”€í•´ì£¼ì„¸ìš”. ğŸ’™",
                    "ìŠ¬í”ˆ ì¼ì´ ìˆìœ¼ì…¨êµ°ìš”. í•¨ê»˜ ì´ì•¼ê¸°í•´ë´ìš”. ğŸ¤—"
                ]
            },
            anxiety: { 
                icon: 'ğŸ˜°', 
                name: 'ì•ˆì • ìƒë‹´ì‚¬', 
                desc: 'ë¶ˆì•ˆí•œ ë§ˆìŒì„ ë‹¬ë˜ë“œë ¤ìš”',
                image: 'avatar/mark_free_ko/anxious.png',
                responses: [
                    "ë¶ˆì•ˆí•˜ì‹  ë§ˆìŒì´ ëŠê»´ì ¸ìš”. ğŸ˜° ë¬´ì—‡ì´ ê±±ì •ë˜ì‹œë‚˜ìš”?",
                    "ê±±ì •ì´ ë§ìœ¼ì‹œêµ°ìš”. ğŸŒ¸ í•˜ë‚˜ì”© ì •ë¦¬í•´ë³¼ê¹Œìš”?",
                    "ê¸´ì¥í•˜ì§€ ë§ˆì„¸ìš”. í•¨ê»˜ í•´ê²°í•´ë´ìš”. ğŸ’ª"
                ]
            },
            anger: { 
                icon: 'ğŸ˜ ', 
                name: 'ì§„ì • ìƒë‹´ì‚¬', 
                desc: 'í™”ë‚œ ë§ˆìŒì„ ì´í•´í•´ìš”',
                image: 'avatar/mark_free_ko/angry.png',
                responses: [
                    "í™”ê°€ ë‚˜ì‹  ê²ƒ ê°™ë„¤ìš”. ğŸ˜¤ ì–´ë–¤ ì¼ ë•Œë¬¸ì¸ì§€ ë§ì”€í•´ì£¼ì„¸ìš”.",
                    "ë¶„ë…¸ë¥¼ ëŠë¼ê³  ê³„ì‹œëŠ”êµ°ìš”. ğŸ”¥ ë§ˆìŒê» í‘œí˜„í•´ì£¼ì„¸ìš”.",
                    "í˜ë“  ìƒí™©ì´ì‹  ê²ƒ ê°™ì•„ìš”. ì €ì—ê²Œ í„¸ì–´ë†“ìœ¼ì„¸ìš”. ğŸ’­"
                ]
            }
        };
        
        function changeEmotion(emotion, icon) {
            currentEmotion = emotion;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
            const avatar = document.getElementById('avatar');
            const emotionData = emotions[emotion];
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            avatar.textContent = 'â³';
            avatar.style.background = 'rgba(255, 255, 255, 0.3)';
            
            // ì•„ë°”íƒ€ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ
            if (avatarType === 'emoji') {
                // ì´ëª¨ì§€ ìŠ¤íƒ€ì¼
                avatar.innerHTML = '';
                avatar.textContent = emotionData.icon;
                avatar.style.background = 'rgba(255, 255, 255, 0.2)';
            } else {
                // ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ - ë¡œì»¬ ê°•ì•„ì§€ ì´ë¯¸ì§€ ì‚¬ìš©
                avatar.innerHTML = `<img src="${emotionData.image}" 
                                   style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" 
                                   alt="${emotion} ì•„ë°”íƒ€"
                                   onerror="this.parentElement.textContent='${emotionData.icon}'">`;
                avatar.style.background = 'rgba(255, 255, 255, 0.2)';
            }
            
            document.getElementById('current-emotion').textContent = emotionData.name;
            document.getElementById('emotion-description').textContent = emotionData.desc;
            document.getElementById('emotion-status').textContent = `${emotionData.icon} ${emotion}`;
            
            // ìƒ‰ìƒ íš¨ê³¼
            avatar.style.transform = 'scale(1.1)';
            setTimeout(() => {
                avatar.style.transform = 'scale(1)';
            }, 300);
            
            console.log(`ê°ì • ë³€ê²½: ${emotion} (íƒ€ì…: ${avatarType})`);
        }
        
        function changeAvatarType(type) {
            avatarType = type;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.avatar-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            console.log(`âœ¨ ì•„ë°”íƒ€ íƒ€ì… ë³€ê²½: ${type}`);
            
            // í˜„ì¬ ê°ì •ìœ¼ë¡œ ì•„ë°”íƒ€ ë‹¤ì‹œ ìƒì„±
            const avatar = document.getElementById('avatar');
            const emotionData = emotions[currentEmotion];
            
            if (type === 'emoji') {
                // ì´ëª¨ì§€ ìŠ¤íƒ€ì¼
                avatar.innerHTML = '';
                avatar.textContent = emotionData.icon;
                avatar.style.background = 'rgba(255, 255, 255, 0.2)';
                console.log('ğŸ­ ì´ëª¨ì§€ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½');
            } else {
                // ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ - ë¡œì»¬ ê°•ì•„ì§€ ì´ë¯¸ì§€ ì‚¬ìš©
                avatar.innerHTML = `<img src="${emotionData.image}" 
                                   style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" 
                                   alt="${currentEmotion} ì•„ë°”íƒ€"
                                   onerror="this.parentElement.textContent='${emotionData.icon}'">`;
                avatar.style.background = 'rgba(255, 255, 255, 0.2)';
                console.log('ğŸ¶ ê°•ì•„ì§€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½');
            }
        }
        
        async function generateRealAvatar(emotion, userText = '') {
            try {
                // ML-serving API ì‚¬ìš©
                const response = await fetch('http://localhost:8000/api/v1/generate-avatar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: userText || `${emotion} ê°ì •ì„ í‘œí˜„í•´ì£¼ì„¸ìš”`
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('âœ… ì‹¬ë¦¬ìƒë‹´ ì•„ë°”íƒ€ ìƒì„± ì„±ê³µ:', data);
                
                // FastAPI ì‘ë‹µ í˜•ì‹ì— ë§ì¶° ì²˜ë¦¬
                if (data.success && data.avatar_image) {
                    // ìœ„í—˜ë„ì— ë”°ë¥¸ íŠ¹ë³„ ë©”ì‹œì§€ í‘œì‹œ
                    if (data.risk_level === 'critical' && data.risk_message) {
                        console.warn('âš ï¸ ê¸´ê¸‰ ìƒí™© ê°ì§€:', data.risk_message);
                        showEmergencyAlert(data);
                    }
                    
                    return {
                        avatar_image: data.avatar_image,
                        emotion: data.emotion,
                        emotion_message: data.emotion_message,
                        risk_level: data.risk_level,
                        risk_message: data.risk_message,
                        intensity: data.intensity || 0,
                        confidence: data.confidence,
                        analysis_method: data.method || 'bert',
                        special_concerns: data.special_concerns || []
                    };
                } else {
                    throw new Error('ì•„ë°”íƒ€ ìƒì„± ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ì•„ë°”íƒ€ ìƒì„± ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        function showEmergencyAlert(data) {
            // ì‘ê¸‰ ìƒí™© ì•Œë¦¼ í‘œì‹œ
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff4757;
                color: white;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
                z-index: 1000;
                max-width: 300px;
                font-weight: bold;
            `;
            
            alertDiv.innerHTML = `
                <div style="margin-bottom: 10px;">âš ï¸ ê¸´ê¸‰ ìƒí™© ê°ì§€</div>
                <div style="font-size: 0.9em; font-weight: normal;">
                    ${data.risk_message}
                </div>
                <div style="margin-top: 10px; font-size: 0.8em;">
                    ìì‚´ì˜ˆë°©ìƒë‹´ì „í™”: 109 (24ì‹œê°„)
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 10ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 10000);
        }
        
        async function updateAvatarWithMessage(emotion, userText) {
            /**
             * ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•„ë°”íƒ€ë¥¼ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
             */
            const avatar = document.getElementById('avatar');
            const emotionData = emotions[emotion];
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            avatar.textContent = 'ğŸ§ ';
            avatar.style.background = 'rgba(255, 255, 255, 0.3)';
            
            try {
                // ì•„ë°”íƒ€ íƒ€ì…ì´ ì´ëª¨ì§€ë©´ API í˜¸ì¶œ ê±´ë„ˆë›°ê¸°
                if (avatarType === 'emoji') {
                    avatar.innerHTML = '';
                    avatar.textContent = emotionData.icon;
                    avatar.style.background = 'rgba(255, 255, 255, 0.2)';
                    
                    // í˜„ì¬ ê°ì • ì—…ë°ì´íŠ¸
                    currentEmotion = emotion;
                    
                    // ê°ì • ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    document.querySelectorAll('.emotion-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent.includes(emotion) || btn.onclick.toString().includes(`'${emotion}'`)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    console.log(`âœ… ì´ëª¨ì§€ ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${emotion}`);
                    return;
                }
                
                // ì´ë¯¸ì§€ íƒ€ì…ì¼ ê²½ìš° ë¡œì»¬ ê°•ì•„ì§€ ì´ë¯¸ì§€ ì‚¬ìš©
                avatar.innerHTML = `<img src="${emotionData.image}" 
                                   style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" 
                                   alt="${emotion} ì•„ë°”íƒ€"
                                   onerror="this.parentElement.textContent='${emotionData.icon}'">`;
                avatar.style.background = 'rgba(255, 255, 255, 0.2)';
                
                console.log(`ï¿½ ê°•ì•„ì§€ ì•„ë°”íƒ€ í‘œì‹œ: ${emotion}`);
                
            } catch (error) {
                console.error('âŒ ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ë°œìƒì‹œ ê¸°ë³¸ ì´ëª¨ì§€ í‘œì‹œ
                avatar.textContent = emotionData.icon;
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                avatar.style.background = 'rgba(255, 255, 255, 0.2)';
            }
            
            // í˜„ì¬ ê°ì • ì—…ë°ì´íŠ¸
            currentEmotion = emotion;
            
            // ê°ì • ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(emotion) || btn.onclick.toString().includes(`'${emotion}'`)) {
                    btn.classList.add('active');
                }
            });
            
            console.log(`âœ… ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${emotion} (ë©”ì‹œì§€: "${userText}")`);
        }
        
        function addMessage(text, sender = 'user') {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div>${text}</div>
                    <div class="message-time">${timeStr}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™ (ê°•ì œ)
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            return messageDiv;
        }
        
        function analyzeEmotion(text) {
            // ì‹¬ë¦¬ìƒë‹´ ì „ë¬¸ ê°ì • ë¶„ì„ ì‹œìŠ¤í…œ
            const text_lower = text.toLowerCase();
            
            // ê°ì • ì ìˆ˜ ê³„ì‚° ì‹œìŠ¤í…œ
            let emotionScores = {
                sad: 0,
                anxiety: 0,
                anger: 0,
                joy: 0,
                neutral: 0
            };
            
            // === ìš°ìš¸/ìŠ¬í”” íŒ¨í„´ ë¶„ì„ ===
            const sadPatterns = [
                // ì§ì ‘ì  í‘œí˜„
                { pattern: /(ìŠ¬í”„|ìš°ìš¸|ëˆˆë¬¼|ìš¸|ìš¸ì—ˆ|ìš´ë‹¤)/, weight: 3 },
                { pattern: /(í˜ë“¤|ì–´ë ¤ì›Œ|ê´´ë¡œ|ê³ í†µ|ì•„íŒŒ|ìƒì²˜)/, weight: 3 },
                { pattern: /(ì ˆë§|í¬ê¸°|ì˜ë¯¸ì—†|ì†Œìš©ì—†|ê°€ì¹˜ì—†)/, weight: 4 },
                { pattern: /(ì£½ê³ ì‹¶|ì‚¬ë¼ì§€ê³ ì‹¶|ëë‚´ê³ ì‹¶)/, weight: 5 },
                
                // ìƒí™©ì  í‘œí˜„
                { pattern: /(ì•Šì¢‹|ì•ˆì¢‹|ë‚˜ìœì¼|ë¬¸ì œê°€|ì‹¤íŒ¨|ì‹¤ìˆ˜)/, weight: 2 },
                { pattern: /(í˜¼ì|ì™¸ë¡œ|ì“¸ì“¸|í—ˆì „|ê³µí—ˆ)/, weight: 3 },
                { pattern: /(í›„íšŒ|ë¯¸ì•ˆ|ì£„ì±…ê°|ìì±…)/, weight: 3 },
                { pattern: /(í—¤ì–´|ì´ë³„|ë– ë‚˜|ë²„ë ¸|ìƒì—ˆ)/, weight: 4 },
                
                // ì‹ ì²´ì  í‘œí˜„
                { pattern: /(ì ì„ëª»|ì‹ìš•ì—†|ê¸°ë ¥ì—†|ë¬´ê¸°ë ¥)/, weight: 3 },
                { pattern: /(ë¨¸ë¦¬ì•„|ê°€ìŠ´ì•„|ë‹µë‹µ|ìˆ¨ë§‰)/, weight: 2 },
                
                // ì¸ì§€ì  í‘œí˜„
                { pattern: /(ì§‘ì¤‘ì•ˆ|ê¸°ì–µì•ˆ|ìƒê°ì•ˆ|í• ìˆ˜ì—†)/, weight: 2 },
                { pattern: /(ìì‹ ì—†|í™•ì‹ ì—†|ëª¨ë¥´ê² |ì–´ë–»ê²Œí•´ì•¼)/, weight: 2 }
            ];
            
            // === ë¶ˆì•ˆ íŒ¨í„´ ë¶„ì„ ===
            const anxietyPatterns = [
                // ì§ì ‘ì  í‘œí˜„
                { pattern: /(ë¶ˆì•ˆ|ê±±ì •|ë‘ë ¤|ë¬´ì„œ|ê²ë‚˜)/, weight: 3 },
                { pattern: /(ê¸´ì¥|ë–¨ë ¤|ì´ˆì¡°|ì¡°ê¸‰|ì•ˆì ˆë¶€ì ˆ)/, weight: 3 },
                { pattern: /(ìŠ¤íŠ¸ë ˆìŠ¤|ì••ë°•|ë¶€ë‹´|ì§)/, weight: 2 },
                
                // ìƒí™©ì  í‘œí˜„
                { pattern: /(ì‹œí—˜|ë©´ì ‘|ë°œí‘œ|í‰ê°€|íŒë‹¨)/, weight: 2 },
                { pattern: /(ë¯¸ë˜|ì•ìœ¼ë¡œ|ê³„ì†|ë§Œì•½|í˜¹ì‹œ)/, weight: 1 },
                { pattern: /(ì‹¤íŒ¨í• ê¹Œ|í‹€ë ¸ì„ê¹Œ|ì–´ë–¡í•˜ì§€|í°ì¼)/, weight: 3 },
                
                // ì‹ ì²´ì  í‘œí˜„
                { pattern: /(ì‹¬ì¥|ë‘ê·¼|ì‹ì€ë•€|ë–¨ë¦¼|ì–´ì§€ëŸ¬)/, weight: 3 },
                { pattern: /(ìˆ¨ì‰¬ê¸°|í˜¸í¡|ê°€ìŠ´ë‹µë‹µ|ëª©ë§‰)/, weight: 3 },
                
                // ì¸ì§€ì  í‘œí˜„
                { pattern: /(ê³„ì†ìƒê°|ë©ˆì¶”ì§€ì•Š|ë°˜ë³µ|ëŒê³ ëŒ)/, weight: 2 },
                { pattern: /(í™•ì¸|ì²´í¬|ì ê²€|ë‹¤ì‹œ)/, weight: 1 }
            ];
            
            // === ë¶„ë…¸ íŒ¨í„´ ë¶„ì„ ===
            const angerPatterns = [
                // ì§ì ‘ì  í‘œí˜„
                { pattern: /(í™”|ë¶„ë…¸|ì§œì¦|ì—´ë°›|ë¹¡ì³|ë¯¸ì³)/, weight: 3 },
                { pattern: /(ì–µìš¸|ë¶„í•´|ì•½ì˜¬|ë¹¡ì¹˜|ì—´ë¶ˆ)/, weight: 3 },
                { pattern: /(ìš•ë‚˜|ì£½ì´ê³ ì‹¶|ë•Œë¦¬ê³ ì‹¶)/, weight: 4 },
                
                // ìƒí™©ì  í‘œí˜„
                { pattern: /(ë¶ˆê³µí‰|ë¶ˆí•©ë¦¬|ë§ì•ˆë¼|ì´ìƒí•´)/, weight: 2 },
                { pattern: /(ë°°ì‹ |ì†ì˜€|ê±°ì§“ë§|ê¸°ë§Œ)/, weight: 3 },
                { pattern: /(ë¬´ì‹œ|ë¬´ë¡€|í•¨ë¶€ë¡œ|ê±´ë°©)/, weight: 2 },
                
                // ì‹ ì²´ì  í‘œí˜„
                { pattern: /(ë¨¸ë¦¬ë|í˜ˆì••|ì£¼ë¨¹|ì´ê°ˆ)/, weight: 2 },
                { pattern: /(ì–¼êµ´ë¹¨ê°œ|ëœ¨ê±°ì›Œ|í„°ì§ˆê²ƒê°™)/, weight: 2 },
                
                // í–‰ë™ì  í‘œí˜„
                { pattern: /(ì†Œë¦¬ì§€ë¥´|ë˜ì§€|ë¶€ìˆ˜|ê¹¨ëœ¨)/, weight: 3 },
                { pattern: /(í”¼í•˜ê³ ì‹¶|ë³´ê¸°ì‹«|ë©€ë¦¬)/, weight: 2 }
            ];
            
            // === ê¸°ì¨ íŒ¨í„´ ë¶„ì„ ===
            const joyPatterns = [
                // ì§ì ‘ì  í‘œí˜„ (ë¶€ì •ì–´ ì²´í¬ í•„ìš”)
                { pattern: /(ê¸°ì˜|í–‰ë³µ|ì¢‹|ì¦ê±°|ì‹ ë‚˜|ë§Œì¡±)/, weight: 3, checkNegation: true },
                { pattern: /(ìµœê³ |ì™„ë²½|í™˜ìƒ|ëŒ€ë‹¨|ë©‹ì ¸)/, weight: 2, checkNegation: true },
                { pattern: /(ì›ƒìŒ|ë¯¸ì†Œ|ì›ƒê²¨|ì¬ë°Œ)/, weight: 2, checkNegation: true },
                
                // ì„±ì·¨ì  í‘œí˜„
                { pattern: /(ì„±ê³µ|í•´ëƒˆ|ì´ë¤˜|ë‹¬ì„±|ì„±ê³¼)/, weight: 3 },
                { pattern: /(ìŠ¹ì§„|í•©ê²©|í†µê³¼|ì„ ë°œ|ë‹¹ì„ )/, weight: 3 },
                { pattern: /(ì¹­ì°¬|ì¸ì •|ê²©ë ¤|ì‘ì›)/, weight: 2 },
                
                // ê´€ê³„ì  í‘œí˜„
                { pattern: /(ì‚¬ë‘|ì—°ì¸|ê²°í˜¼|ë§Œë‚¨|ë°ì´íŠ¸)/, weight: 2, checkNegation: true },
                { pattern: /(ì¹œêµ¬|ê°€ì¡±|í•¨ê»˜|ê°™ì´)/, weight: 1, checkNegation: true },
                
                // ê¸°ëŒ€ì  í‘œí˜„
                { pattern: /(ê¸°ëŒ€|í¬ë§|ê¿ˆ|ëª©í‘œ|ê³„íš)/, weight: 1, checkNegation: true },
                { pattern: /(ì—¬í–‰|íœ´ê°€|íŒŒí‹°|ì¶•ì œ)/, weight: 2, checkNegation: true }
            ];
            
            // ë¶€ì •ì–´ ê°ì§€
            const negationWords = /(ì•ˆ|ì•Š|ëª»|ì—†|ì•„ë‹ˆ|ë§ê³ |ë¹¼ê³ |ì œì™¸|ê±°ë¶€|ì‹«)/;
            const hasNegation = negationWords.test(text_lower);
            
            // íŒ¨í„´ ë§¤ì¹­ ë° ì ìˆ˜ ê³„ì‚°
            function calculateEmotionScore(patterns, emotionType) {
                let score = 0;
                patterns.forEach(p => {
                    if (p.pattern.test(text_lower)) {
                        // ê¸°ì¨ ê°ì •ì€ ë¶€ì •ì–´ê°€ ìˆìœ¼ë©´ ì ìˆ˜ ê°ì†Œ
                        if (p.checkNegation && hasNegation) {
                            score -= p.weight * 0.5;
                        } else {
                            score += p.weight;
                        }
                    }
                });
                return Math.max(0, score); // ìŒìˆ˜ ë°©ì§€
            }
            
            emotionScores.sad = calculateEmotionScore(sadPatterns, 'sad');
            emotionScores.anxiety = calculateEmotionScore(anxietyPatterns, 'anxiety');
            emotionScores.anger = calculateEmotionScore(angerPatterns, 'anger');
            emotionScores.joy = calculateEmotionScore(joyPatterns, 'joy');
            
            // === íŠ¹ë³„ íŒ¨í„´ ë³´ì • ===
            
            // ì‹¬ê°í•œ ìš°ìš¸ ì‹ í˜¸ ê°ì§€
            if (/(ì£½ê³ ì‹¶|ì‚¬ë¼ì§€ê³ ì‹¶|ëë‚´ê³ ì‹¶|ì†Œìš©ì—†|ì˜ë¯¸ì—†|ê°€ì¹˜ì—†)/.test(text_lower)) {
                emotionScores.sad += 10;
            }
            
            // íŠ¸ë¼ìš°ë§ˆ/PTSD ê´€ë ¨
            if (/(ì•…ëª½|í”Œë˜ì‹œë°±|ê¸°ì–µì´|ë– ì˜¬ë¼|ë‹¤ì‹œë³´ì—¬|ë°˜ë³µ)/.test(text_lower)) {
                emotionScores.anxiety += 5;
                emotionScores.sad += 3;
            }
            
            // ë¶„ë¦¬ë¶ˆì•ˆ/ê´€ê³„ ë¬¸ì œ
            if (/(ë²„ë¦¼ë°›|í˜¼ìë‚¨ê²¨|ë– ë‚ ê¹Œ|ìƒì„ê¹Œ)/.test(text_lower)) {
                emotionScores.anxiety += 4;
                emotionScores.sad += 2;
            }
            
            // ìì¡´ê° ë¬¸ì œ
            if (/(ë‚˜ëŠ”ì•ˆë¼|ëª»ìƒê²¨|ë°”ë³´|ì“¸ëª¨ì—†|ì‹¤íŒ¨ì‘)/.test(text_lower)) {
                emotionScores.sad += 4;
            }
            
            // ê°•ë°•ì  ì‚¬ê³ 
            if (/(ê³„ì†ìƒê°|ë©ˆì¶°ì§€ì§€ì•Š|ë°˜ë³µ|í™•ì¸|ì²´í¬)/.test(text_lower)) {
                emotionScores.anxiety += 3;
            }
            
            // ê°ì • í­ë°œ ì§•í›„
            if (/(ì°¸ì„ìˆ˜ì—†|í•œê³„|í„°ì§ˆê²ƒê°™|í­ë°œ|ê²¬ë”œìˆ˜ì—†)/.test(text_lower)) {
                emotionScores.anger += 4;
                emotionScores.anxiety += 2;
            }
            
            // === ë¬¸ë§¥ì  ê°ì • ì¡°ì • ===
            
            // ì§ˆë¬¸í˜• ë¬¸ì¥ (ë¶ˆì•ˆ ì¦ê°€)
            if (/\?|ì–´ë–¡|ì–´ë–»ê²Œ|ì™œ|ë­ì•¼|ë­”ê°€/.test(text_lower)) {
                emotionScores.anxiety += 1;
            }
            
            // ëŠë‚Œí‘œ ë§ìŒ (ê°ì • ê°•ë„ ì¦ê°€)
            const exclamationCount = (text.match(/!/g) || []).length;
            if (exclamationCount > 1) {
                Object.keys(emotionScores).forEach(emotion => {
                    if (emotionScores[emotion] > 0) {
                        emotionScores[emotion] += exclamationCount;
                    }
                });
            }
            
            // ê¸´ ë¬¸ì¥ (ë³µì¡í•œ ê°ì • ìƒíƒœ)
            if (text.length > 100) {
                emotionScores.anxiety += 1;
            }
            
            // === ìµœì¢… ê°ì • ê²°ì • ===
            
            // ìµœê³  ì ìˆ˜ ê°ì • ì°¾ê¸°
            let maxScore = 0;
            let dominantEmotion = 'neutral';
            
            Object.keys(emotionScores).forEach(emotion => {
                if (emotionScores[emotion] > maxScore) {
                    maxScore = emotionScores[emotion];
                    dominantEmotion = emotion;
                }
            });
            
            // ìµœì†Œ ì„ê³„ê°’ í™•ì¸ (ì ìˆ˜ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´ ì¤‘ë¦½)
            if (maxScore < 2) {
                dominantEmotion = 'neutral';
            }
            
            // ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
            console.log('ğŸ§  ê°ì • ë¶„ì„ ê²°ê³¼:', {
                text: text,
                scores: emotionScores,
                hasNegation: hasNegation,
                result: dominantEmotion
            });
            
            return dominantEmotion;
        }
        
        function generateResponse(userMessage) {
            const emotion = analyzeEmotion(userMessage);
            const emotionData = emotions[emotion];
            const responses = emotionData.responses;
            
            // ì•„ë°”íƒ€ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ (ìƒê°í•˜ëŠ” ëª¨ìŠµ)
            const avatar = document.getElementById('avatar');
            avatar.classList.add('thinking');
            setTimeout(() => avatar.classList.remove('thinking'), 2000);
            
            // ê°ì •ì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ì•„ë°”íƒ€ë„ ë³€ê²½
            if (emotion !== currentEmotion) {
                // ì•„ë°”íƒ€ ë³€ê²½
                changeEmotionWithoutButton(emotion, emotionData.icon);
                
                // ê°ì • ë³€ê²½ ì•Œë¦¼
                setTimeout(() => {
                    addMessage(`ğŸ’­ ê°ì • ìƒíƒœê°€ ${emotionData.name}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ${emotionData.desc}`, 'bot');
                }, 500);
            }
            
            // ëœë¤ ì‘ë‹µ ì„ íƒ
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            return randomResponse;
        }
        
        function changeEmotionWithoutButton(emotion, icon) {
            currentEmotion = emotion;
            
            // ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
            const avatar = document.getElementById('avatar');
            const emotionData = emotions[emotion];
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            avatar.textContent = 'â³';
            avatar.style.background = 'rgba(255, 255, 255, 0.3)';
            
            // ì‹¤ì œ API í˜¸ì¶œë¡œ ì•„ë°”íƒ€ ìƒì„±
            generateRealAvatar(emotion)
                .then(avatarData => {
                    if (avatarData && avatarData.image_base64) {
                        // Base64 ì´ë¯¸ì§€ í‘œì‹œ
                        avatar.innerHTML = `<img src="data:image/png;base64,${avatarData.image_base64}" 
                                           style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" 
                                           alt="${emotion} ì•„ë°”íƒ€">`;
                    } else {
                        // API ì‹¤íŒ¨ì‹œ ì´ëª¨ì§€ fallback
                        avatar.textContent = emotionData.icon;
                    }
                })
                .catch(error => {
                    console.warn('ì•„ë°”íƒ€ ìƒì„± ì‹¤íŒ¨, ì´ëª¨ì§€ ì‚¬ìš©:', error);
                    avatar.textContent = emotionData.icon;
                })
                .finally(() => {
                    avatar.style.background = 'rgba(255, 255, 255, 0.2)';
                });
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(emotion) || btn.onclick.toString().includes(`'${emotion}'`)) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById('current-emotion').textContent = emotionData.name;
            document.getElementById('emotion-description').textContent = emotionData.desc;
            document.getElementById('emotion-status').textContent = `${emotionData.icon} ${emotion}`;
            
            // ìƒ‰ìƒ íš¨ê³¼
            avatar.style.transform = 'scale(1.1)';
            setTimeout(() => {
                avatar.style.transform = 'scale(1)';
            }, 300);
            
            console.log(`ìë™ ê°ì • ë³€ê²½: ${emotion}`);
        }
        
        async function sendMessage() {
            if (isTyping) {
                console.log('â³ ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // ì…ë ¥ ë¹„í™œì„±í™”
            isTyping = true;
            
            try {
                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                addMessage(message, 'user');
                input.value = '';
                
                // ì…ë ¥ì°½ ë†’ì´ ì´ˆê¸°í™”
                input.style.height = 'auto';
                
                // ğŸ§  ì‚¬ìš©ì ë©”ì‹œì§€ë¡œ ê°ì • ë¶„ì„ ë° ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
                const detectedEmotion = analyzeEmotion(message);
                console.log(`ğŸ’¬ ì‚¬ìš©ì ë©”ì‹œì§€ ê°ì • ë¶„ì„: "${message}" â†’ ${detectedEmotion}`);
                
                // ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ (ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰)
                try {
                    await updateAvatarWithMessage(detectedEmotion, message);
                } catch (error) {
                    console.warn('âš ï¸ ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ ì¤‘ ì—ëŸ¬ (ê³„ì† ì§„í–‰):', error);
                }
                
                // ë´‡ ì‘ë‹µ ìƒì„± - ì‹¤ì œ API í˜¸ì¶œ
                const typingMessage = addMessage('ìƒë‹´ì‚¬ê°€ ì…ë ¥ ì¤‘...', 'bot');
                typingMessage.querySelector('.message-bubble div').classList.add('typing');
                
                try {
                    // FastAPI ì„œë²„ì— ì‹¤ì œ ìš”ì²­
                    const response = await fetch('http://localhost:8000/chat/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: 'demo-session-' + Date.now()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('âœ… API ì‘ë‹µ:', data);
                    
                    // íƒ€ì´í•‘ ë©”ì‹œì§€ ì œê±°
                    typingMessage.remove();
                    
                    // ì‹¤ì œ ì‘ë‹µ ì¶”ê°€
                    addMessage(data.response, 'bot');
                    
                    // ê°ì • ë³€ê²½ (APIì—ì„œ ë°›ì€ ê°ì •)
                    if (data.emotion && data.emotion !== currentEmotion) {
                        const emotionData = emotions[data.emotion];
                        if (emotionData) {
                            changeEmotionWithoutButton(data.emotion, emotionData.icon);
                            setTimeout(() => {
                                addMessage(`ğŸ’­ ê°ì • ìƒíƒœê°€ ${emotionData.name}ë¡œ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ${emotionData.desc}`, 'bot');
                            }, 500);
                        }
                    }
                    
                    // ì œì•ˆ ì‚¬í•­ì´ ìˆë‹¤ë©´ ì¶”ê°€
                    if (data.suggestions && data.suggestions.length > 0) {
                        setTimeout(() => {
                            addMessage(`ğŸ’¡ ì œì•ˆ: ${data.suggestions[0]}`, 'bot');
                        }, 1000);
                    }
                    
                    // ìŠ¤í¬ë¡¤ ê°•ì œ ì´ë™
                    const messagesContainer = document.getElementById('messages');
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 200);
                    
                } catch (error) {
                    console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨, ë¡œì»¬ ì‘ë‹µ ì‚¬ìš©:', error);
                    
                    // API ì‹¤íŒ¨ì‹œ fallback: ë¡œì»¬ ì‘ë‹µ ì‚¬ìš©
                    typingMessage.remove();
                    const localResponse = generateResponse(message);
                    addMessage(localResponse, 'bot');
                    
                    // ìŠ¤í¬ë¡¤ ì´ë™
                    const messagesContainer = document.getElementById('messages');
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 200);
                } finally {
                    // ë°˜ë“œì‹œ isTypingì„ falseë¡œ ì„¤ì •
                    isTyping = false;
                }
                
            } catch (error) {
                console.error('âŒ ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', error);
                // ì—ëŸ¬ ë°œìƒí•´ë„ ë°˜ë“œì‹œ isTypingì„ falseë¡œ ì„¤ì •
                isTyping = false;
                
                // ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ì•Œë¦¼
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'bot');
            }
        }
        
        // Enter í‚¤ ì´ë²¤íŠ¸
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // í…ìŠ¤íŠ¸ ì…ë ¥ì‹œ ìë™ í¬ê¸° ì¡°ì ˆ
        document.getElementById('messageInput').addEventListener('input', function(e) {
            e.target.style.height = 'auto';
            e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
        });
        
        // API ìƒíƒœ í™•ì¸ ë° ê¸°ë³¸ ì•„ë°”íƒ€ ìƒì„±
        setTimeout(() => {
            fetch('http://localhost:8000/api/v1/health')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('api-status').textContent = 'ğŸ“¡ API ì—°ê²°ë¨';
                    document.getElementById('api-status').classList.add('connected');
                    console.log('âœ… API ì„œë²„ ì—°ê²° í™•ì¸:', data);
                    
                    // ê¸°ë³¸ ì•„ë°”íƒ€ëŠ” ì´ëª¨ì§€ë¡œ ì‹œì‘ (íƒ€ì… ë³€ê²½ ê°€ëŠ¥)
                    const avatar = document.getElementById('avatar');
                    const emotionData = emotions['neutral'];
                    avatar.textContent = emotionData.icon;
                    console.log('âœ… ê¸°ë³¸ ì´ëª¨ì§€ ì•„ë°”íƒ€ ì„¤ì • ì™„ë£Œ');
                })
                .catch(error => {
                    document.getElementById('api-status').textContent = 'ğŸ“¡ API ì˜¤í”„ë¼ì¸';
                    console.log('âš ï¸ API ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (ë°ëª¨ ëª¨ë“œ)');
                });
        }, 1000);
        
        console.log('ğŸš€ ê°„ë‹¨í•œ ì•„ë°”íƒ€ ì±„íŒ… ë°ëª¨ ì‹œì‘');
        console.log('ğŸ’¡ ì•„ë°”íƒ€ íƒ€ì…ì„ ì„ íƒí•˜ê³  ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!');
    </script>
</body>
</html>